<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="FocusBot.App.Views.KanbanBoardPage"
    x:Name="KanbanPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:entities="using:FocusBot.Core.Entities"
    xmlns:automation="using:Microsoft.UI.Xaml.Automation"
    xmlns:converters="using:FocusBot.App.Converters"
    xmlns:primitives="using:Microsoft.UI.Xaml.Controls.Primitives"
    mc:Ignorable="d"
    Background="{StaticResource FbPageBackgroundBrush}">

    <Grid x:Name="RootGrid" Margin="32" RowSpacing="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Trial banner (visible during active trial) -->
        <Border Grid.Row="0"
                Background="{ThemeResource SystemFillColorSuccessBackgroundBrush}"
                BorderBrush="{ThemeResource SystemFillColorSuccessBrush}"
                BorderThickness="0,0,0,2"
                Padding="12,10"
                Margin="0,0,0,8"
                Visibility="{x:Bind ViewModel.ShowTrialBanner, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                automation:AutomationProperties.Name="Free trial banner">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>
                <StackPanel Grid.Column="0" Orientation="Horizontal" Spacing="8" VerticalAlignment="Center">
                    <FontIcon Glyph="&#xE121;" FontSize="16" Foreground="{ThemeResource SystemFillColorSuccessBrush}" VerticalAlignment="Center"/>
                    <TextBlock Foreground="{StaticResource FbTextPrimaryBrush}" VerticalAlignment="Center" TextWrapping="Wrap">
                        <Run Text="Free trial:"/>
                        <Run Text="{x:Bind ViewModel.TrialTimeRemainingFormatted, Mode=OneWay}" FontWeight="SemiBold"/>
                        <Run Text="remaining. Ends at"/>
                        <Run Text="{x:Bind ViewModel.TrialEndTime, Mode=OneWay, Converter={StaticResource TrialEndTimeConverter}}" FontWeight="SemiBold"/>
                    </TextBlock>
                </StackPanel>
                <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                    <Button Content="Subscribe"
                            Style="{StaticResource FbAccentButtonStyle}"
                            automation:AutomationProperties.Name="Subscribe"
                            Command="{x:Bind ViewModel.OpenSettingsCommand}"/>
                    <Button Content="Enter API Key"
                            Style="{StaticResource FbOutlineButtonStyle}"
                            automation:AutomationProperties.Name="Enter API Key"
                            Command="{x:Bind ViewModel.OpenSettingsCommand}"/>
                </StackPanel>
            </Grid>
        </Border>

        <!-- AI not configured warning (visible when no key / not subscribed) -->
        <Border Grid.Row="1"
                Background="{ThemeResource SystemFillColorCautionBackgroundBrush}"
                BorderBrush="{ThemeResource SystemFillColorCriticalBrush}"
                BorderThickness="0,0,0,2"
                Padding="12,10"
                Margin="0,0,0,8"
                Visibility="{x:Bind ViewModel.IsAiConfigured, Mode=OneWay, Converter={StaticResource InverseBoolToVisibilityConverter}}"
                automation:AutomationProperties.Name="AI not configured warning">
            <StackPanel Orientation="Horizontal" Spacing="8">
                <FontIcon Glyph="&#xE7BA;" FontSize="16" Foreground="{ThemeResource SystemFillColorCriticalBrush}" VerticalAlignment="Center"/>
                <TextBlock Text="AI is not configured. Focus scores will not be available."
                           Foreground="{StaticResource FbTextPrimaryBrush}"
                           VerticalAlignment="Center"
                           TextWrapping="Wrap"/>
                <Button Content="Open Settings"
                        Style="{StaticResource FbOutlineButtonStyle}"
                        automation:AutomationProperties.Name="Open Settings"
                        Command="{x:Bind ViewModel.OpenSettingsCommand}"/>
            </StackPanel>
        </Border>

        <!-- Current foreground window and Focus Status Bar (visible when a task is in progress) -->
        <Grid Grid.Row="2" x:Name="CurrentWindowBar"
              Visibility="{x:Bind ViewModel.IsMonitoring, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
              automation:AutomationProperties.Name="Current foreground window"
              RowSpacing="8"
              Margin="0,0,0,8">
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Window info (compact) -->
            <StackPanel Grid.Row="0" Spacing="2">
                <TextBlock Style="{StaticResource FbWindowInfoTextStyle}" MaxLines="1">
                    <Run Text="Process: "/>
                    <Run Text="{x:Bind ViewModel.CurrentProcessName, Mode=OneWay}" FontWeight="SemiBold"/>
                    <Run Text=" | Window: "/>
                    <Run Text="{x:Bind ViewModel.CurrentWindowTitle, Mode=OneWay}" FontWeight="SemiBold"/>
                </TextBlock>
                <TextBlock Style="{StaticResource FbWindowInfoTextStyle}"
                           automation:AutomationProperties.Name="Time on this window">
                    <Run Text="Time on this window (this visit): "/>
                    <Run Text="{x:Bind ViewModel.WindowElapsedTime, Mode=OneWay}"/>
                    <Run Text=" | Total on this window: "/>
                    <Run Text="{x:Bind ViewModel.WindowTotalElapsedTime, Mode=OneWay}"/>
                </TextBlock>
            </StackPanel>

            <!-- Focus Status Bar (prominent, fixed height); status always visible, spinner only when classifying -->
            <Border Grid.Row="1" Style="{StaticResource FbFocusStatusBarStyle}"
                    Visibility="{x:Bind ViewModel.IsFocusScoreVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                    automation:AutomationProperties.Name="Focus status">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Status icon (only after first classification result) -->
                    <Image Grid.Column="0"
                           Source="{x:Bind ViewModel.FocusStatusIcon, Mode=OneWay}"
                           Width="40" Height="36"
                           Margin="0,0,12,0"
                           VerticalAlignment="Center"
                           Visibility="{x:Bind ViewModel.HasCurrentFocusResult, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>

                    <!-- Spinner only when classifying -->
                    <ProgressRing Grid.Column="1"
                                  IsActive="{x:Bind ViewModel.IsClassifying, Mode=OneWay}"
                                  Visibility="{x:Bind ViewModel.IsClassifying, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                                  Width="24" Height="24"
                                  Margin="0,0,12,0"
                                  VerticalAlignment="Center"/>

                    <!-- Status text and reason (only after result); "Checking..." while classifying -->
                    <StackPanel Grid.Column="2" Spacing="4" VerticalAlignment="Center">
                        <StackPanel Visibility="{x:Bind ViewModel.HasCurrentFocusResult, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                            <TextBlock Text="{x:Bind ViewModel.FocusScoreCategory, Mode=OneWay}"
                                       Style="{StaticResource FbFocusStatusTextStyle}">
                                <TextBlock.Foreground>
                                    <Binding Path="ViewModel.FocusScore" Mode="OneWay">
                                        <Binding.Converter>
                                            <converters:FocusScoreToTextColorConverter/>
                                        </Binding.Converter>
                                    </Binding>
                                </TextBlock.Foreground>
                            </TextBlock>
                            <TextBlock Text="{x:Bind ViewModel.FocusReason, Mode=OneWay}"
                                       Style="{StaticResource FbFocusStatusReasonStyle}"
                                       TextWrapping="Wrap"
                                       MaxLines="2"
                                       TextTrimming="CharacterEllipsis"/>
                        </StackPanel>
                        <TextBlock Text="Checking..."
                                   Style="{StaticResource FbFocusStatusTextStyle}"
                                   Foreground="{StaticResource FbTextSecondaryBrush}"
                                   Visibility="{x:Bind ViewModel.ShowCheckingMessage, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>

        <!-- Header with Add Task and Settings -->
        <Grid Grid.Row="3">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <Button x:Name="AddTaskButton" Grid.Column="0"
                    Content="+ Add Task"
                    Style="{StaticResource FbAccentButtonStyle}"
                    automation:AutomationProperties.Name="Add task"
                    Command="{x:Bind ViewModel.ToggleAddTaskCommand}"
                    Click="AddTaskButton_Click"/>
            <StackPanel Grid.Column="2" Orientation="Horizontal" Spacing="8">
                <Button Content="?"
                        Style="{StaticResource FbOutlineButtonStyle}"
                        automation:AutomationProperties.Name="How it works"
                        Command="{x:Bind ViewModel.OpenHowItWorksCommand}"/>
                <Button Content="Settings"
                        Style="{StaticResource FbOutlineButtonStyle}"
                        automation:AutomationProperties.Name="Settings"
                        Command="{x:Bind ViewModel.OpenSettingsCommand}"/>
            </StackPanel>
        </Grid>

        <!-- Kanban Columns -->
        <Grid Grid.Row="4" ColumnSpacing="16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- To Do Column -->
            <Border Grid.Column="0" 
                    automation:AutomationProperties.Name="To Do column" 
                    Style="{StaticResource ColumnStyle}" 
                    Tag="ToDo"
                    AllowDrop="True" 
                    DragOver="Column_DragOver" 
                    Drop="Column_Drop">
                <Grid RowSpacing="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <!-- Column Header with Count (tinted background) -->
                    <Border Grid.Row="0" Style="{StaticResource FbColumnHeaderAreaStyle}" Background="{StaticResource FbColumnHeaderToDoBrush}">
                        <StackPanel Orientation="Horizontal" Spacing="8" Margin="12,0,12,0">
                            <TextBlock Text="TO DO" Style="{StaticResource FbColumnHeaderStyle}"/>
                            <TextBlock Text="{x:Bind ViewModel.ToDoTasks.Count, Mode=OneWay}" 
                                       Style="{StaticResource FbColumnCountStyle}"/>
                        </StackPanel>
                    </Border>
                    <!-- Header Divider -->
                    <Border Grid.Row="1" Style="{StaticResource FbDividerStyle}" Margin="0,4,0,4"/>
                    <!-- Task List -->
                    <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{x:Bind ViewModel.ToDoTasks, Mode=OneWay}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="entities:UserTask">
                                    <!-- Card with left accent bar -->
                                    <Border Style="{StaticResource CardStyle}" 
                                            Tag="{x:Bind TaskId}"
                                            CanDrag="True" 
                                            DragStarting="TaskCard_DragStarting">
                                        <Grid>
                                            <!-- Left accent bar (neutral) -->
                                            <Border Width="3" 
                                                    Background="{StaticResource FbNeutralAccentBrush}"
                                                    CornerRadius="3,0,0,3"
                                                    HorizontalAlignment="Left"/>
                                            <!-- Card content -->
                                            <Grid Margin="14,12,12,12" RowSpacing="10">
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="*"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                </Grid.RowDefinitions>
                                                <!-- Status badge -->
                                                <Border Grid.Row="0" Style="{StaticResource FbStatusBadgeToDoStyle}" Margin="0,0,0,6">
                                                    <TextBlock Text="To Do" Foreground="{StaticResource FbTextOnAccentBrush}" FontSize="11" FontWeight="SemiBold"/>
                                                </Border>
                                                <!-- Task title (clickable) -->
                                                <HyperlinkButton Grid.Row="1"
                                                                 Padding="0"
                                                                 Command="{Binding DataContext.ViewTaskDetailCommand, ElementName=KanbanPage}"
                                                                 CommandParameter="{Binding TaskId}"
                                                                 automation:AutomationProperties.Name="View task details">
                                                    <TextBlock Text="{x:Bind Description}" 
                                                               Style="{StaticResource FbTaskTitleStyle}"
                                                               MaxLines="3"/>
                                                </HyperlinkButton>
                                                <!-- Total time on task (from previous sessions) -->
                                                <TextBlock Grid.Row="2"
                                                           Text="{x:Bind TotalElapsedSeconds, Mode=OneWay, Converter={StaticResource ElapsedSecondsToTimeStringConverter}}"
                                                           Style="{StaticResource FbSecondaryTextStyle}"
                                                           automation:AutomationProperties.Name="Task total time"/>
                                                <!-- Action divider -->
                                                <Border Grid.Row="3" Style="{StaticResource FbDividerStyle}"/>
                                                <!-- Actions -->
                                                <StackPanel Grid.Row="4" Orientation="Horizontal" Spacing="12">
                                                    <Button Content="Start" 
                                                            Style="{StaticResource FbCardPrimaryActionStyle}"
                                                            automation:AutomationProperties.Name="Start task" 
                                                            Command="{Binding DataContext.MoveToInProgressCommand, ElementName=KanbanPage}"
                                                            CommandParameter="{Binding TaskId}"/>
                                                    <Button Style="{StaticResource FbCardActionButtonStyle}"
                                                            automation:AutomationProperties.Name="View task"
                                                            Command="{Binding DataContext.ViewTaskDetailCommand, ElementName=KanbanPage}"
                                                            CommandParameter="{Binding TaskId}">
                                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                                            <FontIcon Glyph="&#xE8A5;" FontSize="13"/>
                                                            <TextBlock Text="View" FontSize="13"/>
                                                        </StackPanel>
                                                    </Button>
                                                    <Button Style="{StaticResource FbCardActionEditStyle}"
                                                            automation:AutomationProperties.Name="Edit task"
                                                            Click="EditTaskButton_Click">
                                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                                            <FontIcon Glyph="&#xE70F;" FontSize="13"/>
                                                            <TextBlock Text="Edit" FontSize="13"/>
                                                        </StackPanel>
                                                    </Button>
                                                    <Button Style="{StaticResource FbCardActionDeleteStyle}"
                                                            automation:AutomationProperties.Name="Delete task" 
                                                            Command="{Binding DataContext.DeleteTaskCommand, ElementName=KanbanPage}"
                                                            CommandParameter="{Binding TaskId}">
                                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                                            <FontIcon Glyph="&#xE74D;" FontSize="13"/>
                                                            <TextBlock Text="Delete" FontSize="13"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>
                                            </Grid>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>

            <!-- In Progress Column -->
            <Border Grid.Column="1" 
                    automation:AutomationProperties.Name="In Progress column" 
                    Style="{StaticResource ColumnStyle}" 
                    Tag="InProgress"
                    AllowDrop="True" 
                    DragOver="Column_DragOver" 
                    Drop="Column_Drop">
                <Grid RowSpacing="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <!-- Column Header with Count (tinted background) -->
                    <Border Grid.Row="0" Style="{StaticResource FbColumnHeaderAreaStyle}" Background="{StaticResource FbColumnHeaderInProgressBrush}">
                        <StackPanel Orientation="Horizontal" Spacing="8" Margin="12,0,12,0">
                            <TextBlock Text="IN PROGRESS" Style="{StaticResource FbColumnHeaderStyle}"/>
                            <TextBlock Text="{x:Bind ViewModel.InProgressTasks.Count, Mode=OneWay}" 
                                       Style="{StaticResource FbColumnCountStyle}"/>
                        </StackPanel>
                    </Border>
                    <!-- Header Divider -->
                    <Border Grid.Row="1" Style="{StaticResource FbDividerStyle}" Margin="0,4,0,4"/>
                    <!-- Task List -->
                    <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{x:Bind ViewModel.InProgressTasks, Mode=OneWay}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="entities:UserTask">
                                    <!-- Card with left accent bar (active/aligned) -->
                                    <Border Style="{StaticResource CardStyle}" 
                                            Tag="{x:Bind TaskId}"
                                            CanDrag="True" 
                                            DragStarting="TaskCard_DragStarting">
                                        <Grid>
                                            <!-- Left accent bar (dynamic based on focus state) -->
                                            <Border Width="3" 
                                                    CornerRadius="3,0,0,3"
                                                    HorizontalAlignment="Left">
                                                <Border.Background>
                                                    <Binding Path="DataContext.FocusScore" ElementName="KanbanPage" Mode="OneWay">
                                                        <Binding.Converter>
                                                            <converters:FocusScoreToBrushConverter/>
                                                        </Binding.Converter>
                                                    </Binding>
                                                </Border.Background>
                                            </Border>
                                            <!-- Card content -->
                                            <Grid Margin="14,12,12,12" RowSpacing="10">
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="*"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                </Grid.RowDefinitions>
                                                <!-- Status badge (In Progress with fire icon) -->
                                                <Border Grid.Row="0" Style="{StaticResource FbStatusBadgeInProgressStyle}" Margin="0,0,0,6">
                                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                                        <FontIcon Glyph="&#xF0B2;" FontFamily="Segoe Fluent Icons" FontSize="11" Foreground="{StaticResource FbTextOnAccentBrush}"/>
                                                        <TextBlock Text="In Progress" Foreground="{StaticResource FbTextOnAccentBrush}" FontSize="11" FontWeight="SemiBold"/>
                                                    </StackPanel>
                                                </Border>
                                                <!-- Task timer (total time on this task), large for visibility -->
                                                <TextBlock Grid.Row="1"
                                                           Text="{Binding DataContext.TaskElapsedTime, ElementName=KanbanPage}"
                                                           Style="{StaticResource FbTaskTimerInProgressStyle}"
                                                           automation:AutomationProperties.Name="Task elapsed time"/>
                                                <!-- Focus score (visible when we have real score) with color indicator -->
                                                <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="6"
                                                            Visibility="{Binding DataContext.IsFocusScorePercentVisible, ElementName=KanbanPage, Converter={StaticResource BoolToVisibilityConverter}}">
                                                    <Ellipse Width="10" Height="10" VerticalAlignment="Center">
                                                        <Ellipse.Fill>
                                                            <Binding Path="DataContext.FocusScore" ElementName="KanbanPage" Mode="OneWay">
                                                                <Binding.Converter>
                                                                    <converters:FocusScoreToBrushConverter/>
                                                                </Binding.Converter>
                                                            </Binding>
                                                        </Ellipse.Fill>
                                                    </Ellipse>
                                                    <TextBlock VerticalAlignment="Center"
                                                               Style="{StaticResource FbSecondaryTextStyle}"
                                                               automation:AutomationProperties.Name="Focus score">
                                                        <TextBlock.Text>
                                                            <Binding Path="DataContext.CurrentFocusScorePercent" ElementName="KanbanPage" Mode="OneWay">
                                                                <Binding.Converter>
                                                                    <converters:FocusScorePercentFormatConverter/>
                                                                </Binding.Converter>
                                                            </Binding>
                                                        </TextBlock.Text>
                                                    </TextBlock>
                                                </StackPanel>
                                                <!-- Task title (clickable) -->
                                                <HyperlinkButton Grid.Row="3"
                                                                 Padding="0"
                                                                 Command="{Binding DataContext.ViewTaskDetailCommand, ElementName=KanbanPage}"
                                                                 CommandParameter="{Binding TaskId}"
                                                                 automation:AutomationProperties.Name="View task details">
                                                    <TextBlock Text="{x:Bind Description}" 
                                                               Style="{StaticResource FbTaskTitleStyle}"
                                                               MaxLines="3"/>
                                                </HyperlinkButton>
                                                <!-- Action divider -->
                                                <Border Grid.Row="4" Style="{StaticResource FbDividerStyle}"/>
                                                <!-- Actions -->
                                                <StackPanel Grid.Row="5" Orientation="Horizontal" Spacing="12">
                                                    <Button Content="Done" 
                                                            Style="{StaticResource FbCardPrimaryActionStyle}"
                                                            automation:AutomationProperties.Name="Mark done" 
                                                            Command="{Binding DataContext.MoveToDoneCommand, ElementName=KanbanPage}"
                                                            CommandParameter="{Binding TaskId}"/>
                                                    <Button Content="Stop" 
                                                            Style="{StaticResource FbCardActionButtonStyle}"
                                                            automation:AutomationProperties.Name="Stop task" 
                                                            Command="{Binding DataContext.MoveToToDoCommand, ElementName=KanbanPage}"
                                                            CommandParameter="{Binding TaskId}"/>
                                                    <Button Style="{StaticResource FbCardActionButtonStyle}"
                                                            automation:AutomationProperties.Name="View task"
                                                            Command="{Binding DataContext.ViewTaskDetailCommand, ElementName=KanbanPage}"
                                                            CommandParameter="{Binding TaskId}">
                                                        <FontIcon Glyph="&#xE8A5;" FontSize="13"/>
                                                    </Button>
                                                    <Button Style="{StaticResource FbCardActionEditStyle}"
                                                            automation:AutomationProperties.Name="Edit task"
                                                            Click="EditTaskButton_Click">
                                                        <FontIcon Glyph="&#xE70F;" FontSize="13"/>
                                                    </Button>
                                                    <Button Style="{StaticResource FbCardActionDeleteStyle}"
                                                            automation:AutomationProperties.Name="Delete task" 
                                                            Command="{Binding DataContext.DeleteTaskCommand, ElementName=KanbanPage}"
                                                            CommandParameter="{Binding TaskId}">
                                                        <FontIcon Glyph="&#xE74D;" FontSize="13"/>
                                                    </Button>
                                                </StackPanel>
                                            </Grid>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>

            <!-- Done Column (timer uses TotalElapsedSeconds via converter) -->
            <Border Grid.Column="2" 
                    automation:AutomationProperties.Name="Done column" 
                    Style="{StaticResource ColumnStyle}" 
                    Tag="Done"
                    AllowDrop="True" 
                    DragOver="Column_DragOver" 
                    Drop="Column_Drop">
                <Grid RowSpacing="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <!-- Column Header with Count (tinted background) -->
                    <Border Grid.Row="0" Style="{StaticResource FbColumnHeaderAreaStyle}" Background="{StaticResource FbColumnHeaderDoneBrush}">
                        <StackPanel Orientation="Horizontal" Spacing="8" Margin="12,0,12,0">
                            <TextBlock Text="DONE" Style="{StaticResource FbColumnHeaderStyle}"/>
                            <TextBlock Text="{x:Bind ViewModel.DoneTasks.Count, Mode=OneWay}" 
                                       Style="{StaticResource FbColumnCountStyle}"/>
                        </StackPanel>
                    </Border>
                    <!-- Header Divider -->
                    <Border Grid.Row="1" Style="{StaticResource FbDividerStyle}" Margin="0,4,0,4"/>
                    <!-- Task List -->
                    <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{x:Bind ViewModel.DoneTasks, Mode=OneWay}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="entities:UserTask">
                                    <!-- Card with left accent bar (completed; color by focus score when present) -->
                                    <Border Style="{StaticResource CardStyle}" 
                                            Tag="{x:Bind TaskId}"
                                            CanDrag="True" 
                                            DragStarting="TaskCard_DragStarting">
                                        <Grid>
                                            <!-- Left accent bar (focus score color when present, else muted green) -->
                                            <Border Width="3" 
                                                    CornerRadius="3,0,0,3"
                                                    HorizontalAlignment="Left">
                                                <Border.Background>
                                                    <Binding Path="FocusScorePercent" Mode="OneWay">
                                                        <Binding.Converter>
                                                            <converters:NullableFocusScorePercentToBrushConverter/>
                                                        </Binding.Converter>
                                                    </Binding>
                                                </Border.Background>
                                            </Border>
                                            <!-- Card content -->
                                            <Grid Margin="14,12,12,12" RowSpacing="10">
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="*"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                </Grid.RowDefinitions>
                                                <!-- Completed badge -->
                                                <Border Grid.Row="0" Style="{StaticResource FbStatusBadgeCompletedStyle}" Margin="0,0,0,6">
                                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                                        <FontIcon Glyph="&#xE73E;" FontSize="11" Foreground="{StaticResource FbTextOnAccentBrush}"/>
                                                        <TextBlock Text="Completed" Foreground="{StaticResource FbTextOnAccentBrush}" FontSize="11" FontWeight="SemiBold"/>
                                                    </StackPanel>
                                                </Border>
                                                <!-- Total time on task -->
                                                <TextBlock Grid.Row="1"
                                                           Text="{x:Bind TotalElapsedSeconds, Mode=OneWay, Converter={StaticResource ElapsedSecondsToTimeStringConverter}}"
                                                           Style="{StaticResource FbSecondaryTextStyle}"
                                                           automation:AutomationProperties.Name="Task total time"/>
                                                <!-- Focus score (visible when task has focus score) with color indicator -->
                                                <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="6"
                                                            Visibility="{x:Bind FocusScorePercent, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}">
                                                    <Ellipse Width="10" Height="10" VerticalAlignment="Center">
                                                        <Ellipse.Fill>
                                                            <Binding Path="FocusScorePercent" Mode="OneWay">
                                                                <Binding.Converter>
                                                                    <converters:NullableFocusScorePercentToBrushConverter/>
                                                                </Binding.Converter>
                                                            </Binding>
                                                        </Ellipse.Fill>
                                                    </Ellipse>
                                                    <TextBlock VerticalAlignment="Center"
                                                               Style="{StaticResource FbSecondaryTextStyle}"
                                                               automation:AutomationProperties.Name="Focus score">
                                                        <TextBlock.Text>
                                                            <Binding Path="FocusScorePercent" Mode="OneWay">
                                                                <Binding.Converter>
                                                                    <converters:NullableIntToFocusScoreFormatConverter/>
                                                                </Binding.Converter>
                                                            </Binding>
                                                        </TextBlock.Text>
                                                    </TextBlock>
                                                </StackPanel>
                                                <!-- Task title (clickable, slightly muted) -->
                                                <HyperlinkButton Grid.Row="3"
                                                                 Padding="0"
                                                                 Command="{Binding DataContext.ViewTaskDetailCommand, ElementName=KanbanPage}"
                                                                 CommandParameter="{Binding TaskId}"
                                                                 automation:AutomationProperties.Name="View task details">
                                                    <TextBlock Text="{x:Bind Description}" 
                                                               Style="{StaticResource FbTaskTitleStyle}"
                                                               Opacity="0.8"
                                                               MaxLines="3"/>
                                                </HyperlinkButton>
                                                <!-- Action divider -->
                                                <Border Grid.Row="4" Style="{StaticResource FbDividerStyle}"/>
                                                <!-- Actions -->
                                                <StackPanel Grid.Row="5" Orientation="Horizontal" Spacing="12">
                                                    <Button Style="{StaticResource FbCardActionButtonStyle}"
                                                            automation:AutomationProperties.Name="View task"
                                                            Command="{Binding DataContext.ViewTaskDetailCommand, ElementName=KanbanPage}"
                                                            CommandParameter="{Binding TaskId}">
                                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                                            <FontIcon Glyph="&#xE8A5;" FontSize="13"/>
                                                            <TextBlock Text="View" FontSize="13"/>
                                                        </StackPanel>
                                                    </Button>
                                                    <Button Style="{StaticResource FbCardActionEditStyle}"
                                                            automation:AutomationProperties.Name="Edit task"
                                                            Click="EditTaskButton_Click">
                                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                                            <FontIcon Glyph="&#xE70F;" FontSize="13"/>
                                                            <TextBlock Text="Edit" FontSize="13"/>
                                                        </StackPanel>
                                                    </Button>
                                                    <Button Style="{StaticResource FbCardActionDeleteStyle}"
                                                            automation:AutomationProperties.Name="Delete task" 
                                                            Command="{Binding DataContext.DeleteTaskCommand, ElementName=KanbanPage}"
                                                            CommandParameter="{Binding TaskId}">
                                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                                            <FontIcon Glyph="&#xE74D;" FontSize="13"/>
                                                            <TextBlock Text="Delete" FontSize="13"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>
                                            </Grid>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Grid>

        <!-- AI provider/model and error indicator (farthest top-right, only when AI is configured) -->
        <StackPanel Grid.Row="0"
                    Grid.RowSpan="4"
                    HorizontalAlignment="Right"
                    VerticalAlignment="Top"
                    Margin="0,0,0,0"
                    Orientation="Horizontal"
                    Spacing="6"
                    Visibility="{x:Bind ViewModel.IsAiConfigured, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                    automation:AutomationProperties.Name="AI provider and model">
            <TextBlock Text="{x:Bind ViewModel.AiProviderAndModelDisplay, Mode=OneWay}"
                       FontSize="11"
                       Foreground="{StaticResource FbTextSecondaryBrush}"
                       MaxLines="1"
                       TextTrimming="CharacterEllipsis"
                       VerticalAlignment="Center"/>
            <Ellipse Width="8" Height="8"
                    Fill="{StaticResource FbAlignedAccentBrush}"
                    Visibility="{x:Bind ViewModel.IsAiStatusOk, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                    VerticalAlignment="Center"
                    automation:AutomationProperties.Name="AI status OK"/>
            <FontIcon Glyph="&#xE7BA;"
                      FontSize="14"
                      Foreground="{ThemeResource SystemFillColorCriticalBrush}"
                      Visibility="{x:Bind ViewModel.HasAiRequestError, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                      VerticalAlignment="Center"
                      automation:AutomationProperties.Name="AI request error">
                <ToolTipService.ToolTip>
                    <ToolTip Content="{x:Bind ViewModel.AiRequestError, Mode=OneWay}"/>
                </ToolTipService.ToolTip>
            </FontIcon>
        </StackPanel>

        <!-- Add Task Popup (light dismiss, draft preserved when closed, centered) -->
        <primitives:Popup x:Name="AddTaskPopup"
                          Grid.Row="0"
                          Grid.RowSpan="4"
                          IsLightDismissEnabled="True">
            <Grid x:Name="AddTaskOverlay"
                  Background="#40000000"
                  HorizontalAlignment="Stretch"
                  VerticalAlignment="Stretch">
                <Border Background="{StaticResource FbCardBackgroundBrush}"
                        BorderBrush="{StaticResource FbCardBorderBrush}"
                        BorderThickness="1"
                        CornerRadius="{StaticResource FbCornerRadiusMedium}"
                        Padding="16"
                        MinWidth="320"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center">
                    <StackPanel Spacing="12">
                        <TextBox x:Name="AddTaskDescriptionBox"
                                 TabIndex="0"
                                 automation:AutomationProperties.Name="Task description"
                                 Text="{x:Bind ViewModel.NewTaskDescription, Mode=TwoWay}"
                                 PlaceholderText="What are you working on?"
                                 CornerRadius="{StaticResource FbCornerRadiusSmall}"
                                 KeyDown="AddTaskPopup_KeyDown"/>
                        <TextBox x:Name="AddTaskContextBox"
                                 TabIndex="1"
                                 automation:AutomationProperties.Name="Task context"
                                 Text="{x:Bind ViewModel.NewTaskContext, Mode=TwoWay}"
                                 PlaceholderText="Context (optional)"
                                 CornerRadius="{StaticResource FbCornerRadiusSmall}"
                                 KeyDown="AddTaskPopup_KeyDown"/>
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Button Content="Add Task"
                                    TabIndex="2"
                                    Style="{StaticResource FbAccentButtonStyle}"
                                    automation:AutomationProperties.Name="Add task"
                                    Command="{x:Bind ViewModel.AddTaskCommand}"/>
                            <Button Content="Cancel"
                                    TabIndex="3"
                                    Style="{StaticResource FbOutlineButtonStyle}"
                                    automation:AutomationProperties.Name="Cancel"
                                    Command="{x:Bind ViewModel.ToggleAddTaskCommand}"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>
        </primitives:Popup>

        <!-- Edit Task Popup (light dismiss, draft preserved when closed, centered) -->
        <primitives:Popup x:Name="EditTaskPopup"
                          Grid.Row="0"
                          Grid.RowSpan="4"
                          IsLightDismissEnabled="True">
            <Grid x:Name="EditTaskOverlay"
                  Background="#40000000"
                  HorizontalAlignment="Stretch"
                  VerticalAlignment="Stretch">
                <Border Background="{StaticResource FbCardBackgroundBrush}"
                        BorderBrush="{StaticResource FbCardBorderBrush}"
                        BorderThickness="1"
                        CornerRadius="{StaticResource FbCornerRadiusMedium}"
                        Padding="16"
                        MinWidth="320"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center">
                    <StackPanel Spacing="12">
                        <TextBox x:Name="EditTaskDescriptionBox"
                                 TabIndex="0"
                                 automation:AutomationProperties.Name="Edit task description"
                                 Text="{x:Bind ViewModel.EditTaskDescription, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                 PlaceholderText="What are you working on?"
                                 CornerRadius="{StaticResource FbCornerRadiusSmall}"
                                 KeyDown="EditTaskPopup_KeyDown"/>
                        <TextBox x:Name="EditTaskContextBox"
                                 TabIndex="1"
                                 automation:AutomationProperties.Name="Edit task context"
                                 Text="{x:Bind ViewModel.EditTaskContext, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                 PlaceholderText="Context (optional)"
                                 CornerRadius="{StaticResource FbCornerRadiusSmall}"
                                 KeyDown="EditTaskPopup_KeyDown"/>
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <Button Content="Save"
                                    TabIndex="2"
                                    Style="{StaticResource FbAccentButtonStyle}"
                                    automation:AutomationProperties.Name="Save task"
                                    Command="{x:Bind ViewModel.SaveEditTaskCommand}"/>
                            <Button Content="Cancel"
                                    TabIndex="3"
                                    Style="{StaticResource FbOutlineButtonStyle}"
                                    automation:AutomationProperties.Name="Cancel"
                                    Command="{x:Bind ViewModel.CloseEditTaskCommand}"/>
                        </StackPanel>
                    </StackPanel>
                </Border>
            </Grid>
        </primitives:Popup>
    </Grid>
</Page>
