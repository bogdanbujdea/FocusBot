<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="FocusBot.App.Views.KanbanBoardPage"
    x:Name="KanbanPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:entities="using:FocusBot.Core.Entities"
    xmlns:automation="using:Microsoft.UI.Xaml.Automation"
    xmlns:converters="using:FocusBot.App.Converters"
    xmlns:primitives="using:Microsoft.UI.Xaml.Controls.Primitives"
    mc:Ignorable="d"
    Background="{StaticResource FbPageBackgroundBrush}">

    <Grid Margin="32" RowSpacing="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Current foreground window (visible when a task is in progress) -->
        <Border Grid.Row="0" x:Name="CurrentWindowBar"
                Visibility="{x:Bind ViewModel.IsMonitoring, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                automation:AutomationProperties.Name="Current foreground window"
                Padding="0,0,0,8">
            <StackPanel Spacing="4">
                <TextBlock Style="{StaticResource FbSecondaryTextStyle}">
                    <Run Text="Process: "/>
                    <Run Text="{x:Bind ViewModel.CurrentProcessName, Mode=OneWay}"/>
                    <Run Text=" | Window: "/>
                    <Run Text="{x:Bind ViewModel.CurrentWindowTitle, Mode=OneWay}"/>
                </TextBlock>
                <TextBlock Style="{StaticResource FbSecondaryTextStyle}"
                           automation:AutomationProperties.Name="Time on this window">
                    <Run Text="Time on this window (this visit): "/>
                    <Run Text="{x:Bind ViewModel.WindowElapsedTime, Mode=OneWay}"/>
                </TextBlock>
                <TextBlock Style="{StaticResource FbSecondaryTextStyle}"
                           automation:AutomationProperties.Name="Total time on this window">
                    <Run Text="Total on this window: "/>
                    <Run Text="{x:Bind ViewModel.WindowTotalElapsedTime, Mode=OneWay}"/>
                </TextBlock>
                <TextBlock Style="{StaticResource FbSecondaryTextStyle}"
                           Visibility="{x:Bind ViewModel.IsFocusScoreVisible, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                           automation:AutomationProperties.Name="Focus score">
                    <Run Text="Focus: "/>
                    <Run Text="{x:Bind ViewModel.FocusScoreCategory, Mode=OneWay}"/>
                    <Run Text=" - "/>
                    <Run Text="{x:Bind ViewModel.FocusReason, Mode=OneWay}"/>
                </TextBlock>
            </StackPanel>
        </Border>

        <!-- Header with Add Task and Settings -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <Button x:Name="AddTaskButton" Grid.Column="0"
                    Content="+ Add Task"
                    Style="{StaticResource FbAccentButtonStyle}"
                    automation:AutomationProperties.Name="Add task"
                    Command="{x:Bind ViewModel.ToggleAddTaskCommand}"
                    Click="AddTaskButton_Click"/>
            <Button Grid.Column="2"
                    Content="Settings"
                    Style="{StaticResource FbOutlineButtonStyle}"
                    automation:AutomationProperties.Name="Settings"
                    Command="{x:Bind ViewModel.OpenSettingsCommand}"/>
        </Grid>

        <!-- Kanban Columns -->
        <Grid Grid.Row="2" ColumnSpacing="16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- To Do Column -->
            <Border Grid.Column="0" 
                    automation:AutomationProperties.Name="To Do column" 
                    Style="{StaticResource ColumnStyle}" 
                    Tag="ToDo"
                    AllowDrop="True" 
                    DragOver="Column_DragOver" 
                    Drop="Column_Drop">
                <Grid RowSpacing="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <!-- Column Header with Count -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="TO DO" Style="{StaticResource FbColumnHeaderStyle}"/>
                        <TextBlock Text="{x:Bind ViewModel.ToDoTasks.Count, Mode=OneWay}" 
                                   Style="{StaticResource FbColumnCountStyle}"/>
                    </StackPanel>
                    <!-- Header Divider -->
                    <Border Grid.Row="1" Style="{StaticResource FbDividerStyle}" Margin="0,4,0,4"/>
                    <!-- Task List -->
                    <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{x:Bind ViewModel.ToDoTasks, Mode=OneWay}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="entities:UserTask">
                                    <!-- Card with left accent bar -->
                                    <Border Style="{StaticResource CardStyle}" 
                                            Tag="{x:Bind TaskId}"
                                            CanDrag="True" 
                                            DragStarting="TaskCard_DragStarting">
                                        <Grid>
                                            <!-- Left accent bar (neutral) -->
                                            <Border Width="3" 
                                                    Background="{StaticResource FbNeutralAccentBrush}"
                                                    CornerRadius="3,0,0,3"
                                                    HorizontalAlignment="Left"/>
                                            <!-- Card content -->
                                            <Grid Margin="14,12,12,12" RowSpacing="10">
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="*"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                </Grid.RowDefinitions>
                                                <!-- Task title (clickable) -->
                                                <HyperlinkButton Grid.Row="0"
                                                                 Padding="0"
                                                                 Command="{Binding DataContext.ViewTaskDetailCommand, ElementName=KanbanPage}"
                                                                 CommandParameter="{Binding TaskId}"
                                                                 automation:AutomationProperties.Name="View task details">
                                                    <TextBlock Text="{x:Bind Description}" 
                                                               Style="{StaticResource FbTaskTitleStyle}"
                                                               MaxLines="3"/>
                                                </HyperlinkButton>
                                                <!-- Total time on task (from previous sessions) -->
                                                <TextBlock Grid.Row="1"
                                                           Text="{x:Bind TotalElapsedSeconds, Mode=OneWay, Converter={StaticResource ElapsedSecondsToTimeStringConverter}}"
                                                           Style="{StaticResource FbSecondaryTextStyle}"
                                                           automation:AutomationProperties.Name="Task total time"/>
                                                <!-- Action divider -->
                                                <Border Grid.Row="2" Style="{StaticResource FbDividerStyle}"/>
                                                <!-- Actions -->
                                                <StackPanel Grid.Row="3" Orientation="Horizontal" Spacing="12">
                                                    <Button Content="Start" 
                                                            Style="{StaticResource FbCardPrimaryActionStyle}"
                                                            automation:AutomationProperties.Name="Start task" 
                                                            Command="{Binding DataContext.MoveToInProgressCommand, ElementName=KanbanPage}"
                                                            CommandParameter="{Binding TaskId}"/>
                                                    <Button Style="{StaticResource FbCardActionButtonStyle}"
                                                            automation:AutomationProperties.Name="View task"
                                                            Command="{Binding DataContext.ViewTaskDetailCommand, ElementName=KanbanPage}"
                                                            CommandParameter="{Binding TaskId}">
                                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                                            <FontIcon Glyph="&#xE8A5;" FontSize="12"/>
                                                            <TextBlock Text="View" FontSize="12"/>
                                                        </StackPanel>
                                                    </Button>
                                                    <Button Style="{StaticResource FbCardActionButtonStyle}"
                                                            automation:AutomationProperties.Name="Edit task"
                                                            Click="EditTaskButton_Click">
                                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                                            <FontIcon Glyph="&#xE70F;" FontSize="12"/>
                                                            <TextBlock Text="Edit" FontSize="12"/>
                                                        </StackPanel>
                                                    </Button>
                                                    <Button Style="{StaticResource FbCardActionButtonStyle}"
                                                            automation:AutomationProperties.Name="Delete task" 
                                                            Command="{Binding DataContext.DeleteTaskCommand, ElementName=KanbanPage}"
                                                            CommandParameter="{Binding TaskId}">
                                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                                            <FontIcon Glyph="&#xE74D;" FontSize="12"/>
                                                            <TextBlock Text="Delete" FontSize="12"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>
                                            </Grid>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>

            <!-- In Progress Column -->
            <Border Grid.Column="1" 
                    automation:AutomationProperties.Name="In Progress column" 
                    Style="{StaticResource ColumnStyle}" 
                    Tag="InProgress"
                    AllowDrop="True" 
                    DragOver="Column_DragOver" 
                    Drop="Column_Drop">
                <Grid RowSpacing="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <!-- Column Header with Count -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="IN PROGRESS" Style="{StaticResource FbColumnHeaderStyle}"/>
                        <TextBlock Text="{x:Bind ViewModel.InProgressTasks.Count, Mode=OneWay}" 
                                   Style="{StaticResource FbColumnCountStyle}"/>
                    </StackPanel>
                    <!-- Header Divider -->
                    <Border Grid.Row="1" Style="{StaticResource FbDividerStyle}" Margin="0,4,0,4"/>
                    <!-- Task List -->
                    <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{x:Bind ViewModel.InProgressTasks, Mode=OneWay}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="entities:UserTask">
                                    <!-- Card with left accent bar (active/aligned) -->
                                    <Border Style="{StaticResource CardStyle}" 
                                            Tag="{x:Bind TaskId}"
                                            CanDrag="True" 
                                            DragStarting="TaskCard_DragStarting">
                                        <Grid>
                                            <!-- Left accent bar (active - green) -->
                                            <Border Width="3" 
                                                    Background="{StaticResource FbAlignedAccentBrush}"
                                                    CornerRadius="3,0,0,3"
                                                    HorizontalAlignment="Left"/>
                                            <!-- Card content -->
                                            <Grid Margin="14,12,12,12" RowSpacing="10">
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="*"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                </Grid.RowDefinitions>
                                                <!-- Status badge -->
                                                <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="6">
                                                    <Ellipse Width="6" Height="6" 
                                                             Fill="{StaticResource FbAlignedAccentBrush}"/>
                                                    <TextBlock Text="Active" 
                                                               Style="{StaticResource FbSecondaryTextStyle}"/>
                                                </StackPanel>
                                                <!-- Task timer (total time on this task) -->
                                                <TextBlock Grid.Row="1"
                                                           Text="{Binding DataContext.TaskElapsedTime, ElementName=KanbanPage}"
                                                           Style="{StaticResource FbSecondaryTextStyle}"
                                                           automation:AutomationProperties.Name="Task elapsed time"/>
                                                <!-- Focus score (visible when we have real score) -->
                                                <TextBlock Grid.Row="2"
                                                           Visibility="{Binding DataContext.IsFocusScorePercentVisible, ElementName=KanbanPage, Converter={StaticResource BoolToVisibilityConverter}}"
                                                           Style="{StaticResource FbSecondaryTextStyle}"
                                                           automation:AutomationProperties.Name="Focus score">
                                                    <TextBlock.Text>
                                                        <Binding Path="DataContext.CurrentFocusScorePercent" ElementName="KanbanPage" Mode="OneWay">
                                                            <Binding.Converter>
                                                                <converters:FocusScorePercentFormatConverter/>
                                                            </Binding.Converter>
                                                        </Binding>
                                                    </TextBlock.Text>
                                                </TextBlock>
                                                <!-- Task title (clickable) -->
                                                <HyperlinkButton Grid.Row="3"
                                                                 Padding="0"
                                                                 Command="{Binding DataContext.ViewTaskDetailCommand, ElementName=KanbanPage}"
                                                                 CommandParameter="{Binding TaskId}"
                                                                 automation:AutomationProperties.Name="View task details">
                                                    <TextBlock Text="{x:Bind Description}" 
                                                               Style="{StaticResource FbTaskTitleStyle}"
                                                               MaxLines="3"/>
                                                </HyperlinkButton>
                                                <!-- Action divider -->
                                                <Border Grid.Row="4" Style="{StaticResource FbDividerStyle}"/>
                                                <!-- Actions -->
                                                <StackPanel Grid.Row="5" Orientation="Horizontal" Spacing="12">
                                                    <Button Content="Done" 
                                                            Style="{StaticResource FbCardPrimaryActionStyle}"
                                                            automation:AutomationProperties.Name="Mark done" 
                                                            Command="{Binding DataContext.MoveToDoneCommand, ElementName=KanbanPage}"
                                                            CommandParameter="{Binding TaskId}"/>
                                                    <Button Content="Stop" 
                                                            Style="{StaticResource FbCardActionButtonStyle}"
                                                            automation:AutomationProperties.Name="Stop task" 
                                                            Command="{Binding DataContext.MoveToToDoCommand, ElementName=KanbanPage}"
                                                            CommandParameter="{Binding TaskId}"/>
                                                    <Button Style="{StaticResource FbCardActionButtonStyle}"
                                                            automation:AutomationProperties.Name="View task"
                                                            Command="{Binding DataContext.ViewTaskDetailCommand, ElementName=KanbanPage}"
                                                            CommandParameter="{Binding TaskId}">
                                                        <FontIcon Glyph="&#xE8A5;" FontSize="12"/>
                                                    </Button>
                                                    <Button Style="{StaticResource FbCardActionButtonStyle}"
                                                            automation:AutomationProperties.Name="Edit task"
                                                            Click="EditTaskButton_Click">
                                                        <FontIcon Glyph="&#xE70F;" FontSize="12"/>
                                                    </Button>
                                                    <Button Style="{StaticResource FbCardActionButtonStyle}"
                                                            automation:AutomationProperties.Name="Delete task" 
                                                            Command="{Binding DataContext.DeleteTaskCommand, ElementName=KanbanPage}"
                                                            CommandParameter="{Binding TaskId}">
                                                        <FontIcon Glyph="&#xE74D;" FontSize="12"/>
                                                    </Button>
                                                </StackPanel>
                                            </Grid>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>

            <!-- Done Column (timer uses TotalElapsedSeconds via converter) -->
            <Border Grid.Column="2" 
                    automation:AutomationProperties.Name="Done column" 
                    Style="{StaticResource ColumnStyle}" 
                    Tag="Done"
                    AllowDrop="True" 
                    DragOver="Column_DragOver" 
                    Drop="Column_Drop">
                <Grid RowSpacing="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <!-- Column Header with Count -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="DONE" Style="{StaticResource FbColumnHeaderStyle}"/>
                        <TextBlock Text="{x:Bind ViewModel.DoneTasks.Count, Mode=OneWay}" 
                                   Style="{StaticResource FbColumnCountStyle}"/>
                    </StackPanel>
                    <!-- Header Divider -->
                    <Border Grid.Row="1" Style="{StaticResource FbDividerStyle}" Margin="0,4,0,4"/>
                    <!-- Task List -->
                    <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{x:Bind ViewModel.DoneTasks, Mode=OneWay}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="entities:UserTask">
                                    <!-- Card with left accent bar (completed) -->
                                    <Border Style="{StaticResource CardStyle}" 
                                            Tag="{x:Bind TaskId}"
                                            CanDrag="True" 
                                            DragStarting="TaskCard_DragStarting">
                                        <Grid>
                                            <!-- Left accent bar (completed - muted green) -->
                                            <Border Width="3" 
                                                    Background="{StaticResource FbAlignedAccentBrush}"
                                                    Opacity="0.5"
                                                    CornerRadius="3,0,0,3"
                                                    HorizontalAlignment="Left"/>
                                            <!-- Card content -->
                                            <Grid Margin="14,12,12,12" RowSpacing="10">
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="*"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                </Grid.RowDefinitions>
                                                <!-- Completed badge -->
                                                <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="6">
                                                    <FontIcon Glyph="&#xE73E;" FontSize="10"
                                                              Foreground="{StaticResource FbTextSecondaryBrush}"/>
                                                    <TextBlock Text="Completed" 
                                                               Style="{StaticResource FbSecondaryTextStyle}"/>
                                                </StackPanel>
                                                <!-- Total time on task -->
                                                <TextBlock Grid.Row="1"
                                                           Text="{x:Bind TotalElapsedSeconds, Mode=OneWay, Converter={StaticResource ElapsedSecondsToTimeStringConverter}}"
                                                           Style="{StaticResource FbSecondaryTextStyle}"
                                                           automation:AutomationProperties.Name="Task total time"/>
                                                <!-- Focus score (visible when task has focus score) -->
                                                <TextBlock Grid.Row="2"
                                                           Visibility="{x:Bind FocusScorePercent, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}"
                                                           Style="{StaticResource FbSecondaryTextStyle}"
                                                           automation:AutomationProperties.Name="Focus score">
                                                    <TextBlock.Text>
                                                        <Binding Path="FocusScorePercent" Mode="OneWay">
                                                            <Binding.Converter>
                                                                <converters:NullableIntToFocusScoreFormatConverter/>
                                                            </Binding.Converter>
                                                        </Binding>
                                                    </TextBlock.Text>
                                                </TextBlock>
                                                <!-- Task title (clickable, slightly muted) -->
                                                <HyperlinkButton Grid.Row="3"
                                                                 Padding="0"
                                                                 Command="{Binding DataContext.ViewTaskDetailCommand, ElementName=KanbanPage}"
                                                                 CommandParameter="{Binding TaskId}"
                                                                 automation:AutomationProperties.Name="View task details">
                                                    <TextBlock Text="{x:Bind Description}" 
                                                               Style="{StaticResource FbTaskTitleStyle}"
                                                               Opacity="0.8"
                                                               MaxLines="3"/>
                                                </HyperlinkButton>
                                                <!-- Action divider -->
                                                <Border Grid.Row="4" Style="{StaticResource FbDividerStyle}"/>
                                                <!-- Actions -->
                                                <StackPanel Grid.Row="5" Orientation="Horizontal" Spacing="12">
                                                    <Button Style="{StaticResource FbCardActionButtonStyle}"
                                                            automation:AutomationProperties.Name="View task"
                                                            Command="{Binding DataContext.ViewTaskDetailCommand, ElementName=KanbanPage}"
                                                            CommandParameter="{Binding TaskId}">
                                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                                            <FontIcon Glyph="&#xE8A5;" FontSize="12"/>
                                                            <TextBlock Text="View" FontSize="12"/>
                                                        </StackPanel>
                                                    </Button>
                                                    <Button Style="{StaticResource FbCardActionButtonStyle}"
                                                            automation:AutomationProperties.Name="Edit task"
                                                            Click="EditTaskButton_Click">
                                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                                            <FontIcon Glyph="&#xE70F;" FontSize="12"/>
                                                            <TextBlock Text="Edit" FontSize="12"/>
                                                        </StackPanel>
                                                    </Button>
                                                    <Button Style="{StaticResource FbCardActionButtonStyle}"
                                                            automation:AutomationProperties.Name="Delete task" 
                                                            Command="{Binding DataContext.DeleteTaskCommand, ElementName=KanbanPage}"
                                                            CommandParameter="{Binding TaskId}">
                                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                                            <FontIcon Glyph="&#xE74D;" FontSize="12"/>
                                                            <TextBlock Text="Delete" FontSize="12"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>
                                            </Grid>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Grid>

        <!-- Add Task Popup (light dismiss, draft preserved when closed) -->
        <primitives:Popup x:Name="AddTaskPopup"
                          Grid.Row="0"
                          Grid.RowSpan="3"
                          IsLightDismissEnabled="True"
                          VerticalOffset="8">
            <Border Background="{StaticResource FbCardBackgroundBrush}"
                    BorderBrush="{StaticResource FbCardBorderBrush}"
                    BorderThickness="1"
                    CornerRadius="{StaticResource FbCornerRadiusMedium}"
                    Padding="16"
                    MinWidth="320">
                <StackPanel Spacing="12">
                    <TextBox automation:AutomationProperties.Name="Task description"
                             Text="{x:Bind ViewModel.NewTaskDescription, Mode=TwoWay}"
                             PlaceholderText="What are you working on?"
                             CornerRadius="{StaticResource FbCornerRadiusSmall}"/>
                    <TextBox automation:AutomationProperties.Name="Task context"
                             Text="{x:Bind ViewModel.NewTaskContext, Mode=TwoWay}"
                             PlaceholderText="Context (optional)"
                             CornerRadius="{StaticResource FbCornerRadiusSmall}"/>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button Content="Add Task"
                                Style="{StaticResource FbAccentButtonStyle}"
                                automation:AutomationProperties.Name="Add task"
                                Command="{x:Bind ViewModel.AddTaskCommand}"/>
                        <Button Content="Cancel"
                                Style="{StaticResource FbOutlineButtonStyle}"
                                automation:AutomationProperties.Name="Cancel"
                                Command="{x:Bind ViewModel.ToggleAddTaskCommand}"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </primitives:Popup>

        <!-- Edit Task Popup (light dismiss, draft preserved when closed) -->
        <primitives:Popup x:Name="EditTaskPopup"
                          Grid.Row="0"
                          Grid.RowSpan="3"
                          IsLightDismissEnabled="True"
                          VerticalOffset="8">
            <Border Background="{StaticResource FbCardBackgroundBrush}"
                    BorderBrush="{StaticResource FbCardBorderBrush}"
                    BorderThickness="1"
                    CornerRadius="{StaticResource FbCornerRadiusMedium}"
                    Padding="16"
                    MinWidth="320">
                <StackPanel Spacing="12">
                    <TextBox automation:AutomationProperties.Name="Edit task description"
                             Text="{x:Bind ViewModel.EditTaskDescription, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                             PlaceholderText="What are you working on?"
                             CornerRadius="{StaticResource FbCornerRadiusSmall}"/>
                    <TextBox automation:AutomationProperties.Name="Edit task context"
                             Text="{x:Bind ViewModel.EditTaskContext, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                             PlaceholderText="Context (optional)"
                             CornerRadius="{StaticResource FbCornerRadiusSmall}"/>
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <Button Content="Save"
                                Style="{StaticResource FbAccentButtonStyle}"
                                automation:AutomationProperties.Name="Save task"
                                Command="{x:Bind ViewModel.SaveEditTaskCommand}"/>
                        <Button Content="Cancel"
                                Style="{StaticResource FbOutlineButtonStyle}"
                                automation:AutomationProperties.Name="Cancel"
                                Command="{x:Bind ViewModel.CloseEditTaskCommand}"/>
                    </StackPanel>
                </StackPanel>
            </Border>
        </primitives:Popup>
    </Grid>
</Page>
