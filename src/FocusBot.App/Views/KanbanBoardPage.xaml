<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="FocusBot.App.Views.KanbanBoardPage"
    x:Name="KanbanPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:entities="using:FocusBot.Core.Entities"
    xmlns:automation="using:Microsoft.UI.Xaml.Automation"
    mc:Ignorable="d"
    Background="{StaticResource FbPageBackgroundBrush}">

    <Grid Margin="32" RowSpacing="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Current foreground window (visible when a task is in progress) -->
        <Border Grid.Row="0" x:Name="CurrentWindowBar"
                Visibility="{x:Bind ViewModel.IsMonitoring, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                automation:AutomationProperties.Name="Current foreground window"
                Padding="0,0,0,8">
            <TextBlock Style="{StaticResource FbSecondaryTextStyle}">
                <Run Text="Process: "/>
                <Run Text="{x:Bind ViewModel.CurrentProcessName, Mode=OneWay}"/>
                <Run Text=" | Window: "/>
                <Run Text="{x:Bind ViewModel.CurrentWindowTitle, Mode=OneWay}"/>
            </TextBlock>
        </Border>

        <!-- Header with Add Task and Settings -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <Button x:Name="AddTaskButton" Grid.Column="0"
                    Content="+ Add Task"
                    Style="{StaticResource FbAccentButtonStyle}"
                    automation:AutomationProperties.Name="Add task"
                    Command="{x:Bind ViewModel.ToggleAddTaskCommand}"
                    Click="AddTaskButton_Click"/>
            <Button Grid.Column="2"
                    Content="Settings"
                    Style="{StaticResource FbOutlineButtonStyle}"
                    automation:AutomationProperties.Name="Settings"
                    Command="{x:Bind ViewModel.OpenSettingsCommand}"/>
        </Grid>

        <!-- Add Task Panel -->
        <Border x:Name="AddTaskPanel" Grid.Row="2" 
                Background="{StaticResource FbCardBackgroundBrush}"
                BorderBrush="{StaticResource FbCardBorderBrush}"
                BorderThickness="1"
                CornerRadius="{StaticResource FbCornerRadiusMedium}"
                Padding="16"
                Visibility="Collapsed" 
                HorizontalAlignment="Left"
                MinWidth="320">
            <StackPanel Spacing="12">
                <TextBox automation:AutomationProperties.Name="Task description" 
                         Text="{x:Bind ViewModel.NewTaskDescription, Mode=TwoWay}" 
                         PlaceholderText="What are you working on?"
                         CornerRadius="{StaticResource FbCornerRadiusSmall}"/>
                <StackPanel Orientation="Horizontal" Spacing="8">
                    <Button Content="Add Task" 
                            Style="{StaticResource FbAccentButtonStyle}"
                            automation:AutomationProperties.Name="Add task" 
                            Command="{x:Bind ViewModel.AddTaskCommand}"/>
                    <Button Content="Cancel" 
                            Style="{StaticResource FbOutlineButtonStyle}"
                            automation:AutomationProperties.Name="Cancel"
                            Command="{x:Bind ViewModel.ToggleAddTaskCommand}"/>
                </StackPanel>
            </StackPanel>
        </Border>

        <!-- Kanban Columns -->
        <Grid Grid.Row="3" ColumnSpacing="16">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- To Do Column -->
            <Border Grid.Column="0" 
                    automation:AutomationProperties.Name="To Do column" 
                    Style="{StaticResource ColumnStyle}" 
                    Tag="ToDo"
                    AllowDrop="True" 
                    DragOver="Column_DragOver" 
                    Drop="Column_Drop">
                <Grid RowSpacing="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <!-- Column Header with Count -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="TO DO" Style="{StaticResource FbColumnHeaderStyle}"/>
                        <TextBlock Text="{x:Bind ViewModel.ToDoTasks.Count, Mode=OneWay}" 
                                   Style="{StaticResource FbColumnCountStyle}"/>
                    </StackPanel>
                    <!-- Header Divider -->
                    <Border Grid.Row="1" Style="{StaticResource FbDividerStyle}" Margin="0,4,0,4"/>
                    <!-- Task List -->
                    <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{x:Bind ViewModel.ToDoTasks, Mode=OneWay}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="entities:UserTask">
                                    <!-- Card with left accent bar -->
                                    <Border Style="{StaticResource CardStyle}" 
                                            Tag="{x:Bind TaskId}"
                                            CanDrag="True" 
                                            DragStarting="TaskCard_DragStarting">
                                        <Grid>
                                            <!-- Left accent bar (neutral) -->
                                            <Border Width="3" 
                                                    Background="{StaticResource FbNeutralAccentBrush}"
                                                    CornerRadius="3,0,0,3"
                                                    HorizontalAlignment="Left"/>
                                            <!-- Card content -->
                                            <Grid Margin="14,12,12,12" RowSpacing="10">
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="*"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                </Grid.RowDefinitions>
                                                <!-- Task title -->
                                                <TextBlock Grid.Row="0" 
                                                           Text="{x:Bind Description}" 
                                                           Style="{StaticResource FbTaskTitleStyle}"
                                                           MaxLines="3"/>
                                                <!-- Action divider -->
                                                <Border Grid.Row="1" Style="{StaticResource FbDividerStyle}"/>
                                                <!-- Actions -->
                                                <StackPanel Grid.Row="2" Orientation="Horizontal" Spacing="12">
                                                    <Button Content="Start" 
                                                            Style="{StaticResource FbCardPrimaryActionStyle}"
                                                            automation:AutomationProperties.Name="Start task" 
                                                            Command="{Binding DataContext.MoveToInProgressCommand, ElementName=KanbanPage}"
                                                            CommandParameter="{Binding TaskId}"/>
                                                    <Button Style="{StaticResource FbCardActionButtonStyle}"
                                                            automation:AutomationProperties.Name="Delete task" 
                                                            Command="{Binding DataContext.DeleteTaskCommand, ElementName=KanbanPage}"
                                                            CommandParameter="{Binding TaskId}">
                                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                                            <FontIcon Glyph="&#xE74D;" FontSize="12"/>
                                                            <TextBlock Text="Delete" FontSize="12"/>
                                                        </StackPanel>
                                                    </Button>
                                                </StackPanel>
                                            </Grid>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>

            <!-- In Progress Column -->
            <Border Grid.Column="1" 
                    automation:AutomationProperties.Name="In Progress column" 
                    Style="{StaticResource ColumnStyle}" 
                    Tag="InProgress"
                    AllowDrop="True" 
                    DragOver="Column_DragOver" 
                    Drop="Column_Drop">
                <Grid RowSpacing="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <!-- Column Header with Count -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="IN PROGRESS" Style="{StaticResource FbColumnHeaderStyle}"/>
                        <TextBlock Text="{x:Bind ViewModel.InProgressTasks.Count, Mode=OneWay}" 
                                   Style="{StaticResource FbColumnCountStyle}"/>
                    </StackPanel>
                    <!-- Header Divider -->
                    <Border Grid.Row="1" Style="{StaticResource FbDividerStyle}" Margin="0,4,0,4"/>
                    <!-- Task List -->
                    <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{x:Bind ViewModel.InProgressTasks, Mode=OneWay}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="entities:UserTask">
                                    <!-- Card with left accent bar (active/aligned) -->
                                    <Border Style="{StaticResource CardStyle}" 
                                            Tag="{x:Bind TaskId}"
                                            CanDrag="True" 
                                            DragStarting="TaskCard_DragStarting">
                                        <Grid>
                                            <!-- Left accent bar (active - green) -->
                                            <Border Width="3" 
                                                    Background="{StaticResource FbAlignedAccentBrush}"
                                                    CornerRadius="3,0,0,3"
                                                    HorizontalAlignment="Left"/>
                                            <!-- Card content -->
                                            <Grid Margin="14,12,12,12" RowSpacing="10">
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="*"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                </Grid.RowDefinitions>
                                                <!-- Status badge -->
                                                <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="6">
                                                    <Ellipse Width="6" Height="6" 
                                                             Fill="{StaticResource FbAlignedAccentBrush}"/>
                                                    <TextBlock Text="Active" 
                                                               Style="{StaticResource FbSecondaryTextStyle}"/>
                                                </StackPanel>
                                                <!-- Task title -->
                                                <TextBlock Grid.Row="1" 
                                                           Text="{x:Bind Description}" 
                                                           Style="{StaticResource FbTaskTitleStyle}"
                                                           MaxLines="3"/>
                                                <!-- Action divider -->
                                                <Border Grid.Row="2" Style="{StaticResource FbDividerStyle}"/>
                                                <!-- Actions -->
                                                <StackPanel Grid.Row="3" Orientation="Horizontal" Spacing="12">
                                                    <Button Content="Done" 
                                                            Style="{StaticResource FbCardPrimaryActionStyle}"
                                                            automation:AutomationProperties.Name="Mark done" 
                                                            Command="{Binding DataContext.MoveToDoneCommand, ElementName=KanbanPage}"
                                                            CommandParameter="{Binding TaskId}"/>
                                                    <Button Content="Stop" 
                                                            Style="{StaticResource FbCardActionButtonStyle}"
                                                            automation:AutomationProperties.Name="Stop task" 
                                                            Command="{Binding DataContext.MoveToToDoCommand, ElementName=KanbanPage}"
                                                            CommandParameter="{Binding TaskId}"/>
                                                    <Button Style="{StaticResource FbCardActionButtonStyle}"
                                                            automation:AutomationProperties.Name="Delete task" 
                                                            Command="{Binding DataContext.DeleteTaskCommand, ElementName=KanbanPage}"
                                                            CommandParameter="{Binding TaskId}">
                                                        <FontIcon Glyph="&#xE74D;" FontSize="12"/>
                                                    </Button>
                                                </StackPanel>
                                            </Grid>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>

            <!-- Done Column -->
            <Border Grid.Column="2" 
                    automation:AutomationProperties.Name="Done column" 
                    Style="{StaticResource ColumnStyle}" 
                    Tag="Done"
                    AllowDrop="True" 
                    DragOver="Column_DragOver" 
                    Drop="Column_Drop">
                <Grid RowSpacing="12">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    <!-- Column Header with Count -->
                    <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="8">
                        <TextBlock Text="DONE" Style="{StaticResource FbColumnHeaderStyle}"/>
                        <TextBlock Text="{x:Bind ViewModel.DoneTasks.Count, Mode=OneWay}" 
                                   Style="{StaticResource FbColumnCountStyle}"/>
                    </StackPanel>
                    <!-- Header Divider -->
                    <Border Grid.Row="1" Style="{StaticResource FbDividerStyle}" Margin="0,4,0,4"/>
                    <!-- Task List -->
                    <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
                        <ItemsControl ItemsSource="{x:Bind ViewModel.DoneTasks, Mode=OneWay}">
                            <ItemsControl.ItemTemplate>
                                <DataTemplate x:DataType="entities:UserTask">
                                    <!-- Card with left accent bar (completed) -->
                                    <Border Style="{StaticResource CardStyle}" 
                                            Tag="{x:Bind TaskId}"
                                            CanDrag="True" 
                                            DragStarting="TaskCard_DragStarting">
                                        <Grid>
                                            <!-- Left accent bar (completed - muted green) -->
                                            <Border Width="3" 
                                                    Background="{StaticResource FbAlignedAccentBrush}"
                                                    Opacity="0.5"
                                                    CornerRadius="3,0,0,3"
                                                    HorizontalAlignment="Left"/>
                                            <!-- Card content -->
                                            <Grid Margin="14,12,12,12" RowSpacing="10">
                                                <Grid.RowDefinitions>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="*"/>
                                                    <RowDefinition Height="Auto"/>
                                                    <RowDefinition Height="Auto"/>
                                                </Grid.RowDefinitions>
                                                <!-- Completed badge -->
                                                <StackPanel Grid.Row="0" Orientation="Horizontal" Spacing="6">
                                                    <FontIcon Glyph="&#xE73E;" FontSize="10"
                                                              Foreground="{StaticResource FbTextSecondaryBrush}"/>
                                                    <TextBlock Text="Completed" 
                                                               Style="{StaticResource FbSecondaryTextStyle}"/>
                                                </StackPanel>
                                                <!-- Task title (slightly muted) -->
                                                <TextBlock Grid.Row="1" 
                                                           Text="{x:Bind Description}" 
                                                           Style="{StaticResource FbTaskTitleStyle}"
                                                           Opacity="0.8"
                                                           MaxLines="3"/>
                                                <!-- Action divider -->
                                                <Border Grid.Row="2" Style="{StaticResource FbDividerStyle}"/>
                                                <!-- Actions -->
                                                <Button Grid.Row="3"
                                                        Style="{StaticResource FbCardActionButtonStyle}"
                                                        automation:AutomationProperties.Name="Delete task" 
                                                        Command="{Binding DataContext.DeleteTaskCommand, ElementName=KanbanPage}"
                                                        CommandParameter="{Binding TaskId}"
                                                        HorizontalAlignment="Left">
                                                    <StackPanel Orientation="Horizontal" Spacing="4">
                                                        <FontIcon Glyph="&#xE74D;" FontSize="12"/>
                                                        <TextBlock Text="Delete" FontSize="12"/>
                                                    </StackPanel>
                                                </Button>
                                            </Grid>
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>
                    </ScrollViewer>
                </Grid>
            </Border>
        </Grid>
    </Grid>
</Page>
