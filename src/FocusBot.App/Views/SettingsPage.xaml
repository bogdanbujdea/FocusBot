<?xml version="1.0" encoding="utf-8"?>
<Page
    x:Class="FocusBot.App.Views.SettingsPage"
    x:Name="SettingsPageRoot"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:automation="using:Microsoft.UI.Xaml.Automation"
    mc:Ignorable="d"
    Background="{StaticResource FbPageBackgroundBrush}">

    <ScrollViewer VerticalScrollBarVisibility="Auto">
        <StackPanel Margin="32" Spacing="24">
            <!-- Trial Status Banner -->
            <Border Background="{ThemeResource SystemFillColorSuccessBackgroundBrush}"
                    BorderBrush="{ThemeResource SystemFillColorSuccessBrush}"
                    BorderThickness="1"
                    CornerRadius="{StaticResource FbCornerRadiusMedium}"
                    Padding="16"
                    Visibility="{x:Bind ViewModel.ApiKeySection.IsTrialActive, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                <StackPanel Spacing="8">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE121;" FontSize="16" Foreground="{ThemeResource SystemFillColorSuccessBrush}" VerticalAlignment="Center"/>
                        <TextBlock Text="Free Trial Active" FontWeight="SemiBold" FontSize="14"/>
                    </StackPanel>
                    <TextBlock Text="{x:Bind ViewModel.ApiKeySection.TrialStatusText, Mode=OneWay}"
                               Foreground="{StaticResource FbTextSecondaryBrush}"
                               FontSize="13"
                               TextWrapping="Wrap"/>
                    <TextBlock Text="Subscribe or enter your own API key before the trial ends to continue using AI features."
                               Foreground="{StaticResource FbTextSecondaryBrush}"
                               FontSize="13"
                               TextWrapping="Wrap"/>
                </StackPanel>
            </Border>

            <!-- Trial Expired Banner -->
            <Border Background="{ThemeResource SystemFillColorCautionBackgroundBrush}"
                    BorderBrush="{ThemeResource SystemFillColorCriticalBrush}"
                    BorderThickness="1"
                    CornerRadius="{StaticResource FbCornerRadiusMedium}"
                    Padding="16"
                    Visibility="{x:Bind ViewModel.ApiKeySection.IsTrialExpired, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}">
                <StackPanel Spacing="8">
                    <StackPanel Orientation="Horizontal" Spacing="8">
                        <FontIcon Glyph="&#xE7BA;" FontSize="16" Foreground="{ThemeResource SystemFillColorCriticalBrush}" VerticalAlignment="Center"/>
                        <TextBlock Text="Free Trial Expired" FontWeight="SemiBold" FontSize="14"/>
                    </StackPanel>
                    <TextBlock Text="{x:Bind ViewModel.ApiKeySection.TrialStatusText, Mode=OneWay}"
                               Foreground="{StaticResource FbTextSecondaryBrush}"
                               FontSize="13"
                               TextWrapping="Wrap"/>
                </StackPanel>
            </Border>

            <!-- AI Provider and API Key Section -->
            <Border Background="{StaticResource FbCardBackgroundBrush}"
                    BorderBrush="{StaticResource FbCardBorderBrush}"
                    BorderThickness="1"
                    CornerRadius="{StaticResource FbCornerRadiusMedium}"
                    Padding="16">
                <StackPanel Spacing="16">
                    <TextBlock Text="AI Provider"
                               Style="{StaticResource FbColumnHeaderStyle}"
                               FontSize="14"/>
                    <TextBlock Text="How do you want to use AI features?"
                               Style="{StaticResource FbColumnHeaderStyle}"
                               FontSize="14"/>

                    <!-- Own Key Mode -->
                    <RadioButton x:Name="OwnKeyRadio"
                                 GroupName="ApiKeyMode"
                                 IsChecked="{x:Bind ViewModel.ApiKeySection.IsOwnKeyMode, Mode=OneWay}"
                                 Command="{x:Bind ViewModel.ApiKeySection.SelectOwnKeyModeCommand}"
                                 automation:AutomationProperties.Name="Use my own API key">
                        <StackPanel Spacing="4">
                            <TextBlock Text="Use my own API key (Free)"
                                       FontWeight="SemiBold"/>
                            <TextBlock Text="You provide an API key from OpenAI, Anthropic, etc."
                                       Foreground="{StaticResource FbTextSecondaryBrush}"
                                       FontSize="12"
                                       TextWrapping="Wrap"/>
                        </StackPanel>
                    </RadioButton>

                    <!-- API Key Fields (visible when Own mode selected) -->
                    <StackPanel Visibility="{x:Bind ViewModel.ApiKeySection.IsOwnKeyMode, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                                Margin="28,0,0,0"
                                Spacing="12">
                        <ComboBox ItemsSource="{x:Bind ViewModel.ApiKeySection.Providers, Mode=OneWay}"
                                  SelectedItem="{x:Bind ViewModel.ApiKeySection.SelectedProvider, Mode=TwoWay}"
                                  DisplayMemberPath="DisplayName"
                                  HorizontalAlignment="Stretch"
                                  IsEnabled="{x:Bind ViewModel.ApiKeySection.ShowInputArea, Mode=OneWay}"
                                  automation:AutomationProperties.Name="AI provider"/>

                        <TextBlock Text="AI Model"
                                   Style="{StaticResource FbColumnHeaderStyle}"
                                   FontSize="14"/>
                        <ComboBox ItemsSource="{x:Bind ViewModel.ApiKeySection.AvailableModels, Mode=OneWay}"
                                  SelectedItem="{x:Bind ViewModel.ApiKeySection.SelectedModel, Mode=TwoWay}"
                                  DisplayMemberPath="DisplayName"
                                  HorizontalAlignment="Stretch"
                                  IsEnabled="{x:Bind ViewModel.ApiKeySection.ShowInputArea, Mode=OneWay}"
                                  automation:AutomationProperties.Name="AI model"/>

                        <TextBlock Text="{x:Bind ViewModel.ApiKeySection.ApiKeyLabel, Mode=OneWay}"
                                   Style="{StaticResource FbColumnHeaderStyle}"
                                   FontSize="14"/>
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <TextBlock Text="Required for AI-powered alignment classification."
                                       Foreground="{StaticResource FbTextSecondaryBrush}"
                                       FontSize="12"
                                       TextWrapping="Wrap"
                                       VerticalAlignment="Center"/>
                            <HyperlinkButton Content="Get API key"
                                             NavigateUri="{x:Bind ViewModel.ApiKeySection.ApiKeyHelpUri, Mode=OneWay}"
                                             automation:AutomationProperties.Name="Get API key"/>
                        </StackPanel>

                        <!-- Configured, view mode: masked key + Edit + Clear -->
                        <StackPanel Visibility="{x:Bind ViewModel.ApiKeySection.ShowMaskedDisplay, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                                    Spacing="12">
                            <TextBlock Text="{x:Bind ViewModel.ApiKeySection.MaskedApiKeyDisplay, Mode=OneWay}"
                                       Style="{StaticResource FbSecondaryTextStyle}"
                                       FontFamily="Consolas"
                                       automation:AutomationProperties.Name="Masked API key"/>
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <Button Content="Edit"
                                        Style="{StaticResource FbAccentButtonStyle}"
                                        Command="{x:Bind ViewModel.ApiKeySection.OpenEditCommand}"
                                        automation:AutomationProperties.Name="Edit API key"/>
                                <Button Content="Clear Key"
                                        Style="{StaticResource FbOutlineButtonStyle}"
                                        Command="{x:Bind ViewModel.ApiKeySection.ClearApiKeyCommand}"
                                        automation:AutomationProperties.Name="Clear API key"/>
                            </StackPanel>
                        </StackPanel>

                        <!-- Input mode: no key yet or editing -->
                        <StackPanel Visibility="{x:Bind ViewModel.ApiKeySection.ShowInputArea, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                                    Spacing="12">
                            <TextBox x:Name="ApiKeyInput"
                                     Text="{x:Bind ViewModel.ApiKeySection.ApiKey, Mode=TwoWay}"
                                     TextChanged="ApiKeyInput_TextChanged"
                                     PlaceholderText="Enter API key"
                                     CornerRadius="{StaticResource FbCornerRadiusSmall}"
                                     automation:AutomationProperties.Name="API key"/>
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <Button Content="Save"
                                        Style="{StaticResource FbAccentButtonStyle}"
                                        Command="{x:Bind ViewModel.ApiKeySection.SaveApiKeyCommand}"
                                        IsEnabled="{x:Bind ViewModel.ApiKeySection.CanSave, Mode=OneWay}"
                                        automation:AutomationProperties.Name="Save"/>
                                <Button Content="Cancel"
                                        Style="{StaticResource FbOutlineButtonStyle}"
                                        Command="{x:Bind ViewModel.ApiKeySection.CancelEditCommand}"
                                        Visibility="{x:Bind ViewModel.ApiKeySection.IsEditing, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                                        automation:AutomationProperties.Name="Cancel edit"/>
                            </StackPanel>
                        </StackPanel>
                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE7BA;"
                                      FontSize="16"
                                      Foreground="{ThemeResource SystemFillColorCriticalBrush}"
                                      VerticalAlignment="Center"
                                      Visibility="{x:Bind ViewModel.ApiKeySection.IsStatusError, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                                      automation:AutomationProperties.Name="Error"/>
                            <TextBlock Text="{x:Bind ViewModel.ApiKeySection.StatusMessage, Mode=OneWay}"
                                       FontSize="13"
                                       FontWeight="SemiBold"
                                       Foreground="{ThemeResource SystemFillColorCriticalBrush}"
                                       TextWrapping="Wrap"
                                       VerticalAlignment="Center"
                                       Visibility="{x:Bind ViewModel.ApiKeySection.IsStatusError, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
                            <TextBlock Text="{x:Bind ViewModel.ApiKeySection.StatusMessage, Mode=OneWay}"
                                       FontSize="13"
                                       Foreground="{StaticResource FbTextSecondaryBrush}"
                                       TextWrapping="Wrap"
                                       VerticalAlignment="Center"
                                       Visibility="{x:Bind ViewModel.ApiKeySection.IsStatusError, Mode=OneWay, Converter={StaticResource InverseBoolToVisibilityConverter}}"/>
                        </StackPanel>
                    </StackPanel>

                    <!-- Subscription Mode -->
                    <RadioButton x:Name="SubscriptionRadio"
                                 GroupName="ApiKeyMode"
                                 IsChecked="{x:Bind ViewModel.ApiKeySection.IsSubscriptionMode, Mode=OneWay}"
                                 Command="{x:Bind ViewModel.ApiKeySection.SelectSubscriptionModeCommand}"
                                 automation:AutomationProperties.Name="Subscribe to FocusBot Pro">
                        <StackPanel Spacing="4">
                            <TextBlock Text="Subscribe to FocusBot Pro ($4.99/month)"
                                       FontWeight="SemiBold"/>
                            <TextBlock Text="No API key needed - we handle everything"
                                       Foreground="{StaticResource FbTextSecondaryBrush}"
                                       FontSize="12"
                                       TextWrapping="Wrap"/>
                        </StackPanel>
                    </RadioButton>

                    <!-- Subscription Mode Content -->
                    <StackPanel Visibility="{x:Bind ViewModel.ApiKeySection.IsSubscriptionMode, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                                Margin="28,0,0,0"
                                Spacing="12">
                        <ProgressRing IsActive="{x:Bind ViewModel.ApiKeySection.IsLoadingSubscription, Mode=OneWay}"
                                      Width="24" Height="24"
                                      Visibility="{x:Bind ViewModel.ApiKeySection.IsLoadingSubscription, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>

                        <StackPanel Visibility="{x:Bind ViewModel.ApiKeySection.ShowSubscribeButton, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                                    Spacing="12">
                            <TextBlock TextWrapping="Wrap"
                                       Foreground="{StaticResource FbTextSecondaryBrush}">
                                Unlock AI-powered focus tracking without managing API keys.
                                $4.99/month, cancel anytime.
                            </TextBlock>
                            <Button Content="Subscribe Now"
                                    Style="{StaticResource FbAccentButtonStyle}"
                                    Command="{x:Bind ViewModel.ApiKeySection.SubscribeCommand}"
                                    automation:AutomationProperties.Name="Subscribe Now"/>
                        </StackPanel>

                        <StackPanel Visibility="{x:Bind ViewModel.ApiKeySection.IsSubscribed, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                                    Spacing="12">
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <FontIcon Glyph="&#xE73E;"
                                          Foreground="{ThemeResource SystemFillColorSuccessBrush}"/>
                                <TextBlock Text="Active subscription"
                                           FontWeight="SemiBold"/>
                            </StackPanel>
                            <TextBlock Text="{x:Bind ViewModel.ApiKeySection.SubscriptionStatusText, Mode=OneWay}"
                                       Foreground="{StaticResource FbTextSecondaryBrush}"/>
                            <Button Content="Manage Subscription"
                                    Style="{StaticResource FbOutlineButtonStyle}"
                                    Command="{x:Bind ViewModel.ApiKeySection.ManageSubscriptionCommand}"
                                    automation:AutomationProperties.Name="Manage Subscription"/>
                            <TextBlock TextWrapping="Wrap"
                                      Foreground="{StaticResource FbTextSecondaryBrush}">
                                Your AI-powered focus tracking is active. No setup required - we handle everything!
                            </TextBlock>
                        </StackPanel>

                        <StackPanel Orientation="Horizontal" Spacing="8">
                            <FontIcon Glyph="&#xE7BA;"
                                      FontSize="16"
                                      Foreground="{ThemeResource SystemFillColorCriticalBrush}"
                                      VerticalAlignment="Center"
                                      Visibility="{x:Bind ViewModel.ApiKeySection.IsStatusError, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"
                                      automation:AutomationProperties.Name="Error"/>
                            <TextBlock Text="{x:Bind ViewModel.ApiKeySection.StatusMessage, Mode=OneWay}"
                                       FontSize="13"
                                       FontWeight="SemiBold"
                                       Foreground="{ThemeResource SystemFillColorCriticalBrush}"
                                       TextWrapping="Wrap"
                                       VerticalAlignment="Center"
                                       Visibility="{x:Bind ViewModel.ApiKeySection.IsStatusError, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
                            <TextBlock Text="{x:Bind ViewModel.ApiKeySection.StatusMessage, Mode=OneWay}"
                                       FontSize="13"
                                       Foreground="{StaticResource FbTextSecondaryBrush}"
                                       TextWrapping="Wrap"
                                       VerticalAlignment="Center"
                                       Visibility="{x:Bind ViewModel.ApiKeySection.IsStatusError, Mode=OneWay, Converter={StaticResource InverseBoolToVisibilityConverter}}"/>
                        </StackPanel>
                    </StackPanel>
                </StackPanel>
            </Border>

            <!-- Overlay Settings -->
            <Border Background="{StaticResource FbCardBackgroundBrush}"
                    BorderBrush="{StaticResource FbCardBorderBrush}"
                    BorderThickness="1"
                    CornerRadius="{StaticResource FbCornerRadiusMedium}"
                    Padding="16">
                <StackPanel Spacing="12">
                    <TextBlock Text="Overlay"
                               Style="{StaticResource FbColumnHeaderStyle}"
                               FontSize="14"/>
                    <ToggleSwitch Header="Show Focus Overlay"
                                  IsOn="{x:Bind ViewModel.OverlaySection.IsOverlayEnabled, Mode=TwoWay}"
                                  OnContent="Visible"
                                  OffContent="Hidden"
                                  automation:AutomationProperties.Name="Show focus overlay"/>
                    <TextBlock Text="The overlay shows your focus score and lets you pause/resume tracking without switching windows."
                               Foreground="{StaticResource FbTextSecondaryBrush}"
                               FontSize="13"
                               TextWrapping="Wrap"/>
                </StackPanel>
            </Border>

            <!-- How it works -->
            <Border Background="{StaticResource FbCardBackgroundBrush}"
                    BorderBrush="{StaticResource FbCardBorderBrush}"
                    BorderThickness="1"
                    CornerRadius="{StaticResource FbCornerRadiusMedium}"
                    Padding="16">
                <StackPanel Spacing="12">
                    <TextBlock Text="Help"
                               Style="{StaticResource FbColumnHeaderStyle}"
                               FontSize="14"/>
                    <TextBlock Text="Learn how Focus Bot works and how your data is stored locally."
                               Foreground="{StaticResource FbTextSecondaryBrush}"
                               FontSize="13"
                               TextWrapping="Wrap"/>
                    <Button Content="How it works"
                            Style="{StaticResource FbOutlineButtonStyle}"
                            HorizontalAlignment="Left"
                            Click="HowItWorksButton_Click"
                            automation:AutomationProperties.Name="How it works"/>
                </StackPanel>
            </Border>

            <!-- Back to Board -->
            <Button Content="Back to Board"
                    Style="{StaticResource FbOutlineButtonStyle}"
                    Command="{x:Bind ViewModel.BackCommand}"
                    HorizontalAlignment="Left"
                    automation:AutomationProperties.Name="Back to board"/>
        </StackPanel>
    </ScrollViewer>
</Page>
